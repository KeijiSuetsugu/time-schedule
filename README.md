# タイムカードシステム

職場で使えるモバイル対応のタイムカードシステムです。

## 機能

- ✅ ユーザー認証（ログイン/新規登録）
- ✅ 出勤・退勤打刻
- ✅ 打刻履歴の確認
- ✅ 位置情報記録（オプション）
- ✅ モバイル対応（PWA）
- ✅ セキュアな認証（JWT、パスワードハッシュ化）

## セキュリティ機能

- JWT トークンによる認証
- bcrypt によるパスワードハッシュ化
- 打刻の重複チェック（5分以内の重複を防止）
- 出勤/退勤の整合性チェック
- IPアドレスとデバイス情報の記録

## セットアップ

### 1. 依存関係のインストール

```bash
npm install
```

### 2. 環境変数の設定

`.env` ファイルを作成し、以下の内容を設定してください：

```
DATABASE_URL="file:./dev.db"
JWT_SECRET="your-super-secret-jwt-key-change-this-in-production"
```

**重要**: 本番環境では `JWT_SECRET` を強力なランダム文字列に変更してください。

### 3. データベースの初期化

```bash
npm run db:generate
npm run db:push
```

### 4. 本番環境へのデプロイ（必須）

**各職員のスマホ単独でシステムを起動するには、本番環境にデプロイする必要があります。**

詳細な手順は `docs/DEPLOY.md` を参照してください。

#### クイックスタート（Vercel - 推奨）

1. **GitHubリポジトリにプッシュ**
   ```bash
   git init
   git add .
   git commit -m "Initial commit"
   git remote add origin <あなたのGitHubリポジトリURL>
   git push -u origin main
   ```

2. **Vercelでプロジェクトをインポート**
   - https://vercel.com/ にアクセス
   - GitHubアカウントでログイン
   - 「Add New Project」→ リポジトリを選択 → 「Import」

3. **環境変数を設定**
   - `DATABASE_URL`: PostgreSQLの接続文字列（Vercel Postgresを使用可能）
   - `JWT_SECRET`: 強力なランダム文字列

4. **デプロイ**
   - 「Deploy」をクリック

5. **スマホからアクセス**
   - Vercelが提供するURL（例: `https://your-project.vercel.app`）をスマホのブラウザで開く
   - **このURLはモバイル通信（4G/5G）からもアクセス可能です**
   - PWAとしてインストールすれば、ホーム画面から直接起動できます

#### 開発環境でのテスト

開発環境でテストする場合：
```bash
npm run dev
```

PCのブラウザで [http://localhost:3000](http://localhost:3000) を開いてください。

**開発環境でのモバイルアクセス**: ngrokを使用（`docs/MOBILE_ACCESS.md`を参照）

## 使用方法

### スマホでの初回セットアップ

1. **本番環境のURLをスマホのブラウザで開く**
   - 例: `https://your-project.vercel.app`

2. **PWAとしてインストール**
   - **iOS (Safari)**: 共有ボタン → 「ホーム画面に追加」
   - **Android (Chrome)**: メニュー → 「ホーム画面に追加」

3. **新規登録でアカウントを作成**
   - メールアドレスとパスワードを設定

4. **ログイン後、ダッシュボードで出勤・退勤を打刻**
   - 位置情報の許可を求められたら「許可」を選択

5. **打刻履歴で過去の記録を確認**

**重要**: インストール後は、ホーム画面のアイコンから直接起動できます。インターネット接続があれば、どこからでもアクセス可能です。

## 管理者アカウントの設定

### 手順

1. **通常のアカウントを作成**
   - 本番環境のURL（例: `https://your-project.vercel.app`）で「新規登録」からアカウントを作成
   - メールアドレスとパスワードを設定

2. **管理者権限を付与**
   - ターミナルで以下のコマンドを実行：
   ```bash
   npm run make-admin -- <登録したメールアドレス>
   ```
   
   例：
   ```bash
   npm run make-admin -- admin@example.com
   ```
   
   **または** `npx tsx` を使用：
   ```bash
   npx tsx scripts/make-admin.ts admin@example.com
   ```

3. **管理者としてログイン**
   - 作成したアカウントでログイン
   - ダッシュボードに「場所設定」ボタンと「打刻履歴のエクスポート」セクションが表示されます

### 管理者の機能

- ✅ 打刻場所の設定・管理（`/admin/locations`）
- ✅ 打刻履歴のExcel/PDFエクスポート
- ✅ 15日締めの月次データ管理
- ✅ **職員を選択して年間打刻歴のエクスポート**
- ✅ **全職員の打刻データを個別に管理**

### 注意事項

- 管理者権限はデータベースで設定する必要があります
- 複数の管理者アカウントを作成できます
- 管理者は他のユーザーの打刻履歴もエクスポート可能です

## PWAとしてインストール

本番環境にデプロイ後、スマホでPWAとしてインストールすると、ホーム画面から直接起動できます。

### iOS (Safari)
1. Safariで本番環境のURLを開く
2. 共有ボタン（□↑）をタップ
3. 「ホーム画面に追加」を選択
4. ホーム画面にアイコンが追加されます

### Android (Chrome)
1. Chromeで本番環境のURLを開く
2. メニュー（⋮）をタップ
3. 「ホーム画面に追加」を選択
4. ホーム画面にアイコンが追加されます

インストール後は、インターネット接続があれば、どこからでも（4G/5G/Wi-Fi）アクセス可能です。

## トラブルシューティング

### スマホのブラウザでエラーが出る場合

1. **ネットワークエラー**
   - エラーメッセージ: 「ネットワークエラー: サーバーに接続できません」
   - **対処法**:
     - インターネット接続（4G/5G/Wi-Fi）を確認
     - 本番環境のURLが正しいか確認
     - ブラウザのキャッシュをクリアして再試行

2. **ページが表示されない**
   - **対処法**:
     - HTTPSでアクセスしているか確認（PWAはHTTPSが必要）
     - ブラウザを最新版に更新
     - 別のブラウザで試す（Safari/Chrome）

3. **ログインできない**
   - **対処法**:
     - メールアドレスとパスワードが正しいか確認
     - ブラウザの開発者ツール（F12）でエラーを確認
     - サーバーのログを確認

4. **位置情報が取得できない**
   - **対処法**:
     - ブラウザの位置情報の許可を確認
     - GPSが有効か確認
     - 位置情報サービスをオンにする

5. **PWAとしてインストールできない**
   - **対処法**:
     - HTTPSでアクセスしているか確認
     - ブラウザがPWAに対応しているか確認（Safari iOS 11.3+、Chrome Android）
     - ブラウザのキャッシュをクリア

### 開発環境でのエラー

- **Service Workerのエラー**: 開発環境では無視して問題ありません（本番環境でのみ有効）
- **ポート3000が使用中**: 別のポートを使用するか、既存のプロセスを停止

## 技術スタック

- **フロントエンド**: Next.js 14, React, TypeScript, Tailwind CSS
- **バックエンド**: Next.js API Routes
- **データベース**: SQLite (開発) / PostgreSQL (本番推奨)
- **認証**: JWT, bcrypt
- **ORM**: Prisma

## ライセンス

MIT

